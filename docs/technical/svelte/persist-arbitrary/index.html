<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="/favicon.png" />
        <link rel="stylesheet" href="/styles.css" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>df.id.au - /technical/svelte/persist-arbitrary</title>

		

		<link rel="modulepreload" href="/./_app/start-0434364e.js">
		<link rel="modulepreload" href="/./_app/chunks/vendor-3d5021e0.js">
		<link rel="modulepreload" href="/./_app/pages/__layout.svelte-9b8e5450.js">
		<link rel="modulepreload" href="/./_app/chunks/store-93849798.js">
		<link rel="modulepreload" href="/./_app/pages/technical/__layout.md-934f8e8b.js">
		<link rel="modulepreload" href="/./_app/pages/technical/svelte/persist-arbitrary.md-aef8d8d9.js">
		<link rel="stylesheet" href="/./_app/assets/start-a8cd1609.css">
		<link rel="stylesheet" href="/./_app/assets/pages/__layout.svelte-5a19647c.css">

		<script type="module">
			import { start } from "/./_app/start-0434364e.js";
			start({
				target: document.querySelector("#svelte"),
				paths: {"base":"","assets":"/."},
				session: {},
				host: location.host,
				route: true,
				spa: false,
				trailing_slash: "never",
				hydrate: {
					status: 200,
					error: null,
					nodes: [
						import("/./_app/pages/__layout.svelte-9b8e5450.js"),
						import("/./_app/pages/technical/__layout.md-934f8e8b.js"),
						import("/./_app/pages/technical/svelte/persist-arbitrary.md-aef8d8d9.js")
					],
					page: {
						host: location.host, // TODO this is redundant
						path: "/technical/svelte/persist-arbitrary",
						query: new URLSearchParams(""),
						params: {}
					}
				}
			});
		</script>
	</head>
	<body>
		<div id="svelte">




<div><img src="/13109002_223898111320684_484395489_n.jpg" alt="Dean Fogarty" class="svelte-shurfy">
    <span class="theme svelte-shurfy"><select><option value="light">light</option><option value="dark">dark</option></select></span>
    <h1 class="svelte-shurfy">df.id.au</h1>
    <h4 class="svelte-shurfy">Dean Fogarty</h4>
    / <a href="/">home</a> / <a href="/technical">technical</a> / <a href="/technical/svelte">svelte</a> / persist-arbitrary</div>
<hr>

<main><p>Storing typed data from <a href="https://svelte.dev/docs#4_Prefix_stores_with_$_to_access_their_values" rel="nofollow">Svelte
stores</a>
to browser localStorage.</p>
<hr>
<h2>Previously</h2>
<p>In <a href="/technical/svelte/persist-localStorage">part I</a> we wrapped
<code>localStorage.setItem()</code> and <code>localStorage.getItem()</code> behind a <a href="https://svelte.dev/docs#svelte_store" rel="nofollow">Svelte
store</a>, giving the developer a consistent
interface to both normal stores and localStorage.</p>
<h3>Typed data?</h3>
<p>Our previous solution allows us to store any type of data (say <code>./store.js</code>):</p>
<pre class="language-js"><!-- HTML_TAG_START --><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createLocalStorage <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./localStorage.js'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> aString <span class="token operator">=</span> <span class="token function">createLocalStorage</span><span class="token punctuation">(</span><span class="token string">'aString'</span><span class="token punctuation">,</span> <span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> aStruct <span class="token operator">=</span> <span class="token function">createLocalStorage</span><span class="token punctuation">(</span><span class="token string">'aStruct'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> hi<span class="token operator">:</span> <span class="token string">'world'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> aNumber <span class="token operator">=</span> <span class="token function">createLocalStorage</span><span class="token punctuation">(</span><span class="token string">'aNumber'</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> aBoolean <span class="token operator">=</span> <span class="token function">createLocalStorage</span><span class="token punctuation">(</span><span class="token string">'aBoolean'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre>
<p>but the developer must manually manage it’s type:</p>
<pre class="language-js"><!-- HTML_TAG_START --><code class="language-js"><span class="token operator">&lt;</span>script<span class="token operator">></span>
    <span class="token keyword">import</span> <span class="token punctuation">&#123;</span> aNumber<span class="token punctuation">,</span> aBoolean <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./store.js'</span><span class="token punctuation">;</span>

    $aNumber <span class="token operator">+=</span> <span class="token number">123</span><span class="token punctuation">;</span>            <span class="token comment">// we want 246, but got '123123'</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>$aBoolean <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// will fail as 'true' !== true</span>
        <span class="token operator">...</span>
    <span class="token punctuation">&#125;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><!-- HTML_TAG_END --></pre>
<h2>Our goal?</h2>
<p>We want to provide wrappers around <code>createLocalStorage()</code> that handle
types. For the developer, we want the wrapper use to be as inconvenient as
possible.</p>
<h2>Method</h2>
<p>We need to adjust <code>createLocalStorage()</code> to accept a “pull” and a
“push” functions. These functions will transform the data on the
way back in from  and to localStorage, respectively.</p>
<pre class="language-js"><!-- HTML_TAG_START --><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> writable <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'svelte/store'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">createLocalStorage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> init<span class="token punctuation">,</span> pushFn<span class="token punctuation">,</span> pullFn</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> value <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Pull the previously stored value and transform it on</span>
    <span class="token comment">// the way in. If we don't have a previously stored value,</span>
    <span class="token comment">// transform the initial value and write to localStorage.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        value <span class="token operator">=</span> <span class="token function">pullFn</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>
            key<span class="token punctuation">,</span>
            <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token function">pushFn</span><span class="token punctuation">(</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        value <span class="token operator">=</span> init<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Create our store.</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> subscribe<span class="token punctuation">,</span> set <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">writable</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        subscribe<span class="token punctuation">,</span>
        <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">v<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Apply push function on write.</span>
            localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>
                key<span class="token punctuation">,</span>
                <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token function">pushFn</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">set</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre>
<p>We will create a number of wrapper functions that provide the developer with
options on the type of storage to create; for example:</p>
<pre class="language-js"><!-- HTML_TAG_START --><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createBooleanStorage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> init</span><span class="token punctuation">)</span> <span class="token operator">=></span>
    <span class="token function">createLocalStorage</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> init<span class="token punctuation">,</span> pushBoolean<span class="token punctuation">,</span> pullBoolean<span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre>
<p>and implement the pull and push functions:</p>
<pre class="language-js"><!-- HTML_TAG_START --><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">pushBoolean</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> value <span class="token operator">?</span> <span class="token string">'true'</span> <span class="token operator">:</span> <span class="token string">'false'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">pullBoolean</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> value <span class="token operator">==</span> <span class="token string">'true'</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre>
<h2>Usage</h2>
<p>Our store file looks familiar (say, <code>./store.js</code>):</p>
<pre class="language-js"><!-- HTML_TAG_START --><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createBooleanStorage <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./localStorage.js'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> darkMode <span class="token operator">=</span> <span class="token function">createBooleanStorage</span><span class="token punctuation">(</span>
    <span class="token string">'darkMode'</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre>
<p>as do our components:</p>
<pre class="language-js"><!-- HTML_TAG_START --><code class="language-js"><span class="token operator">&lt;</span>script<span class="token operator">></span>
    <span class="token keyword">import</span> <span class="token punctuation">&#123;</span> darkMode <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./store.js'</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>

<span class="token operator">&lt;</span>select bind<span class="token operator">:</span>value<span class="token operator">=</span><span class="token punctuation">&#123;</span>darkMode<span class="token punctuation">&#125;</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>option value<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token boolean">true</span><span class="token punctuation">&#125;</span><span class="token operator">></span>Yes<span class="token operator">&lt;</span><span class="token operator">/</span>option<span class="token operator">></span>
    <span class="token operator">&lt;</span>option value<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token boolean">false</span><span class="token punctuation">&#125;</span><span class="token operator">></span>No<span class="token operator">&lt;</span><span class="token operator">/</span>option<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>selet<span class="token operator">></span></code><!-- HTML_TAG_END --></pre>
<p>but the developer no longer needs to worry about managing types after pulling
or before pushing to the store.</p>
<h2>Summary</h2>
<p>We have provided wrappers around <code>createLocalStorage()</code> that handle types
without any additional burden on the developer.</p>
<h3>Improvements</h3>
<ul><li>The above example only allows a single transform, centred around managing the
data type. We expand this example to handle doing multiple, arbitrary transforms
in <a href="/technical/svelte/persist-transforms">part III</a>.</li>
<li><a href="https://kit.svelte.dev" rel="nofollow">SvelteKit</a> performs server-side rendering of the
application, so <code>localStorage</code> is not available and the reference to it in
the above example will fail. This should be guarded by <code>browser</code> from
<code>$app/env</code>. More details
<a href="https://kit.svelte.dev/docs#modules-$app-env" rel="nofollow">here</a>.</li></ul>
<h2>More information</h2>
<ul><li><a href="/technical/svelte/persist-localStorage">Part I</a></li>
<li><a href="/technical/svelte/persist-transforms">Part III</a></li></ul></main>

<hr>
<p>Want to say g&#39;day? Drop me an <a href="mailto:dean@df.id.au">email</a>.
    <span class="right svelte-shurfy">Style by <a target="_blank" href="https://uglyduck.ca/typesafe-css">TypeSafe CSS</a></span>
</p>



	
</div>
	</body>

    <script>
        window.goatcounter = { no_onload: true };
        window.addEventListener('sveltekit:navigation-end', (event) => {
            window.goatcounter.count({
                path: location.pathname + location.search + location.hash,
            });
        });
    </script>
    <script data-goatcounter="https://angrytongan.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</html>
